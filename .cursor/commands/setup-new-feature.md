# 新功能设置

## 概览
从初始规划到实施架构，系统化地完成新功能设置。基于Spring Boot + MyBatis Plus + MySQL技术栈的最佳实践。

## 开发流程

### 1. 需求分析与规划

#### 1.1 需求定义
- [ ] **功能范围明确**: 确定功能边界和核心价值
- [ ] **用户故事编写**: 使用"作为...我希望...以便..."格式
- [ ] **验收标准制定**: 明确功能完成标准
- [ ] **技术约束识别**: 性能、安全、兼容性要求
- [ ] **依赖关系分析**: 识别与其他功能的依赖关系

#### 1.2 技术方案设计
- [ ] **架构设计**: 确定分层架构和模块划分
- [ ] **数据模型设计**: 设计实体、DTO、数据库表结构
- [ ] **API设计**: 定义REST API接口规范
- [ ] **安全设计**: 权限控制、数据加密、输入验证
- [ ] **性能设计**: 缓存策略、分页、批量操作

### 2. 开发环境准备

#### 2.1 分支管理
- [ ] **创建功能分支**: `git checkout -b feature/功能名称`
- [ ] **分支命名规范**: 使用`feature/`、`fix/`、`hotfix/`前缀
- [ ] **同步最新代码**: `git pull origin main`
- [ ] **设置上游分支**: `git push -u origin feature/功能名称`

#### 2.2 环境配置
- [ ] **启动依赖服务**: MySQL、Redis、RabbitMQ
- [ ] **配置环境变量**: 数据库连接、密钥配置
- [ ] **验证开发环境**: 确保基础功能正常运行
- [ ] **配置IDE**: 代码格式化、静态检查插件

### 3. 代码实现

#### 3.1 后端开发
- [ ] **实体类创建**: 使用`@Entity`、`@TableName`注解
- [ ] **Mapper接口**: 继承`BaseMapper<T>`，避免注解式SQL
- [ ] **Service层**: 实现业务逻辑，使用`@Transactional`
- [ ] **Controller层**: 处理HTTP请求，使用`@Valid`验证
- [ ] **DTO类**: 定义请求响应对象，使用`@Builder`模式

#### 3.2 数据库设计
- [ ] **表结构设计**: 遵循命名规范，添加注释
- [ ] **索引优化**: 为查询字段添加合适索引
- [ ] **约束设置**: 主键、外键、唯一约束
- [ ] **审计字段**: 创建时间、更新时间、逻辑删除
- [ ] **多租户支持**: 添加租户ID字段

#### 3.3 安全实现
- [ ] **权限控制**: 使用`@PreAuthorize`注解
- [ ] **输入验证**: 使用Jakarta Validation注解
- [ ] **敏感数据加密**: 使用`@EncryptField`注解
- [ ] **XSS防护**: 确保输出转义
- [ ] **SQL注入防护**: 使用参数化查询

### 4. 测试实现

#### 4.1 单元测试
- [ ] **Service层测试**: 使用`@MockBean`模拟依赖
- [ ] **Controller层测试**: 使用`@WebMvcTest`测试API
- [ ] **Repository层测试**: 使用`@DataJpaTest`测试数据访问
- [ ] **测试覆盖率**: 确保核心业务逻辑覆盖率>80%

#### 4.2 集成测试
- [ ] **API集成测试**: 使用`@SpringBootTest`测试完整流程
- [ ] **数据库集成测试**: 使用Testcontainers测试真实数据库
- [ ] **缓存测试**: 验证Redis缓存功能
- [ ] **消息队列测试**: 验证异步消息处理

### 5. 代码质量保证

#### 5.1 代码规范
- [ ] **代码格式化**: 运行`mvn spotless:apply`
- [ ] **静态检查**: 运行`mvn checkstyle:check`
- [ ] **代码审查**: 提交Pull Request进行代码评审
- [ ] **SonarQube检查**: 运行`mvn sonar:sonar`

#### 5.2 性能优化
- [ ] **SQL优化**: 检查慢查询，优化索引
- [ ] **缓存策略**: 合理使用Redis缓存
- [ ] **批量操作**: 使用`saveBatch()`进行批量处理
- [ ] **分页查询**: 使用MyBatis Plus分页插件

### 6. 部署与发布

#### 6.1 环境配置
- [ ] **开发环境**: 本地开发测试
- [ ] **测试环境**: 集成测试验证
- [ ] **预生产环境**: 生产环境模拟
- [ ] **生产环境**: 正式发布部署

#### 6.2 发布流程
- [ ] **代码合并**: 合并到main分支
- [ ] **版本标记**: 创建Git标签
- [ ] **构建部署**: 使用CI/CD流水线
- [ ] **监控验证**: 检查应用健康状态

## 功能设置清单

### 需求阶段
- [ ] 功能需求已明确
- [ ] 用户故事已编写
- [ ] 验收标准已制定
- [ ] 技术方案已设计
- [ ] 依赖关系已分析

### 开发阶段
- [ ] 功能分支已创建
- [ ] 开发环境已配置
- [ ] 数据库表已创建
- [ ] 实体类已实现
- [ ] Mapper接口已实现
- [ ] Service层已实现
- [ ] Controller层已实现
- [ ] DTO类已定义

### 测试阶段
- [ ] 单元测试已编写
- [ ] 集成测试已编写
- [ ] 测试覆盖率达标
- [ ] 性能测试已通过
- [ ] 安全测试已通过

### 质量保证
- [ ] 代码格式化已通过
- [ ] 静态检查已通过
- [ ] 代码审查已通过
- [ ] SonarQube检查已通过
- [ ] 文档已更新

### 部署阶段
- [ ] 测试环境部署成功
- [ ] 预生产环境验证通过
- [ ] 生产环境部署成功
- [ ] 监控告警已配置
- [ ] 回滚方案已准备

## 技术规范

### 代码规范
- **命名规范**: 类名使用单数，方法名语义化
- **文件大小**: 单文件≤500行，单方法≤50行
- **圈复杂度**: ≤10，方法参数≤5个
- **注释要求**: 复杂逻辑必须中文注释
- **格式化**: 使用Spotless统一格式

### 安全规范
- **输入验证**: 使用`@Valid`注解验证输入
- **权限控制**: 使用`@PreAuthorize`控制访问
- **数据加密**: 敏感字段使用`@EncryptField`
- **SQL安全**: 使用参数化查询，避免SQL注入
- **XSS防护**: 输出转义，使用XSS过滤器

### 性能规范
- **数据库优化**: 合理使用索引，避免N+1查询
- **缓存策略**: 合理使用Redis缓存
- **分页查询**: 使用MyBatis Plus分页插件
- **批量操作**: 使用批量处理方法
- **异步处理**: 合理使用异步处理

## 常用命令

### Git操作
```bash
# 创建功能分支
git checkout -b feature/功能名称

# 提交代码
git add .
git commit -m "feat(模块): 功能描述"

# 推送分支
git push -u origin feature/功能名称

# 合并到main
git checkout main
git merge feature/功能名称
```

### Maven操作
```bash
# 代码格式化
mvn spotless:apply

# 运行测试
mvn test

# 代码质量检查
mvn verify 

# 生成覆盖率报告
mvn jacoco:report
```

### 数据库操作
```bash
# 启动数据库
docker-compose up -d mysql

# 运行数据库迁移
mvn flyway:migrate

# 生成数据库文档
mvn liquibase:dbDoc
```

## 注意事项

### 开发注意事项
- 遵循SOLID原则和DRY原则
- 保持代码简洁和可读性
- 及时处理TODO和FIXME注释
- 避免硬编码，使用配置管理
- 注意异常处理和日志记录

### 安全注意事项
- 敏感信息不能硬编码
- 输入参数必须验证
- 输出数据必须转义
- 权限控制必须严格
- 审计日志必须完整

### 性能注意事项
- 避免N+1查询问题
- 合理使用缓存
- 注意内存泄漏
- 控制事务范围
- 优化数据库查询

---

**提示**: 使用此文档作为新功能开发的检查清单，确保每个步骤都得到正确执行，保证代码质量和项目一致性。